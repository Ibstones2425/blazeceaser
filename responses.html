<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Responses - BlazeCeaser</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="container" style="padding-top: 2rem;">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <a href="dashboard.html" class="btn btn-secondary btn-sm mb-2">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </a>
                <h1 class="font-bold text-gradient" style="font-size: 2rem;">Form Responses</h1>
                <p class="text-muted" id="form-title">Loading...</p>
            </div>
            
            <button onclick="exportToCSV()" class="btn btn-primary" id="export-btn" disabled>
                <i class="fa-solid fa-download"></i> Export CSV
            </button>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table" id="response-table">
                    <thead>
                        <tr id="table-head">
                            <th>Date</th>
                            <!-- Dynamic Headers will be added here -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td class="text-center py-4"><div class="loader"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('formId');
        
        let allData = []; // Store data for CSV export

        onAuthStateChanged(auth, async (user) => {
            if (user && formId) {
                // 1. Verify Ownership
                const formSnap = await getDoc(doc(db, "forms", formId));
                if (!formSnap.exists() || formSnap.data().ownerUid !== user.uid) {
                    alert("Unauthorized access");
                    window.location.href = "dashboard.html";
                    return;
                }
                
                document.getElementById('form-title').innerText = formSnap.data().title;
                loadResponses(formId);
            } else {
                window.location.href = "dashboard.html";
            }
        });

        async function loadResponses(fid) {
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            
            try {
                const q = query(
                    collection(db, "responses"),
                    where("formId", "==", fid),
                    orderBy("submittedAt", "desc")
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="100%" class="text-center py-4">No responses yet.</td></tr>';
                    return;
                }

                // 2. Dynamic Headers Logic
                // We scan the first document to see what fields exist (e.g. Name, Email, Message)
                const firstData = snapshot.docs[0].data().answers;
                const headers = Object.keys(firstData);
                
                // Add headers to table
                headers.forEach(key => {
                    const th = document.createElement('th');
                    th.innerText = key.charAt(0).toUpperCase() + key.slice(1); // Capitalize
                    tableHead.appendChild(th);
                });

                // 3. Populate Rows
                let rowsHtml = '';
                allData = []; // Clear array

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.submittedAt.toMillis()).toLocaleString();
                    
                    // Save for CSV
                    allData.push({ date, ...data.answers });

                    rowsHtml += `<tr><td>${date}</td>`;
                    headers.forEach(key => {
                        rowsHtml += `<td>${data.answers[key] || '-'}</td>`;
                    });
                    rowsHtml += `</tr>`;
                });

                tableBody.innerHTML = rowsHtml;
                document.getElementById('export-btn').disabled = false;

            } catch (error) {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-danger">Error loading data. Index may be building.</td></tr>';
            }
        }

        // --- EXPORT CSV FUNCTION ---
        window.exportToCSV = () => {
            if (allData.length === 0) return;

            const headers = Object.keys(allData[0]);
            const csvRows = [];

            // Add Header Row
            csvRows.push(headers.join(','));

            // Add Data Rows
            for (const row of allData) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"'); // Escape quotes
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            // Create File
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'responses.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
    </script>
</body>
</html>