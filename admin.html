<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — Blaze Ceaser</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>

    /* ── Admin badge in navbar ─────────────────────────────── */
    .admin-badge {
      background: var(--accent);
      color: #fff;
      font-family: var(--mono);
      font-size: 0.68rem;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* ── Template list rows ────────────────────────────────── */
    .tpl-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      padding: 0.9rem 1rem;
    }
    .tpl-row:not(:last-child) { border-bottom: 1px solid var(--border); }
    .tpl-info { flex: 1; min-width: 0; }
    .tpl-info .title { font-weight: 600; font-size: 0.95rem; }
    .tpl-info small {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      display: block;
      margin-top: 0.15rem;
    }
    .tpl-actions { display: flex; gap: 0.4rem; flex-shrink: 0; flex-wrap: wrap; }

    /* ── User list rows ────────────────────────────────────── */
    .user-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      padding: 0.9rem 1rem;
    }
    .user-row:not(:last-child) { border-bottom: 1px solid var(--border); }
    .user-info { flex: 1; min-width: 0; }
    .user-info .email { font-weight: 600; font-size: 0.95rem; }
    .user-info small {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      display: block;
      margin-top: 0.15rem;
    }
    .user-actions { display: flex; gap: 0.4rem; flex-shrink: 0; flex-wrap: wrap; }
    .user-coins { color: #f0c040; }

    /* ── Search row ────────────────────────────────────────── */
    .search-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .search-row input { flex: 1; }

    /* ── Modal wide ────────────────────────────────────────── */
    .modal-wide { max-width: 560px; }

    /* ── Top bar for sections ──────────────────────────────── */
    .section-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.85rem;
    }

  </style>
</head>
<body>

  <!-- ── Navbar ───────────────────────────────────────────── -->
  <nav class="navbar">
    <div class="flex items-center gap-1">
      <span class="logo">BLAZE <span>CEASER</span></span>
      <span class="admin-badge">Admin</span>
    </div>
    <div class="nav-actions">
      <span id="adminEmail" class="text-mono text-dim text-sm truncate" style="max-width:160px"></span>
      <button class="btn btn-ghost btn-sm" id="logoutBtn">Exit</button>
    </div>
  </nav>

  <main>
    <div class="container">

      <div class="page-header">
        <h1>Admin Panel</h1>
        <p class="text-dim text-sm">Full control over templates, users and coins.</p>
      </div>

      <!-- ── Tabs ───────────────────────────────────────────── -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="templates">Templates</button>
        <button class="tab-btn" data-tab="users">Users</button>
      </div>

      <!-- ══════════════════════════════════════════════════════
           TEMPLATES TAB
      ══════════════════════════════════════════════════════ -->
      <div class="tab-panel active" id="tab-templates">
        <div class="section-bar">
          <span class="section-title" style="margin-bottom:0;flex:1">All Templates</span>
          <button class="btn btn-primary btn-sm" id="newTplBtn">+ New Template</button>
        </div>
        <div id="tplList" class="card" style="padding:0">
          <div class="loader"><div class="spinner"></div> Loading…</div>
        </div>
      </div>

      <!-- ══════════════════════════════════════════════════════
           USERS TAB
      ══════════════════════════════════════════════════════ -->
      <div class="tab-panel" id="tab-users">
        <div class="search-row">
          <input type="text" id="userSearch" placeholder="Search by email…" />
          <button class="btn btn-primary btn-sm" id="searchBtn">Search</button>
        </div>
        <div id="userList" class="card" style="padding:0">
          <div class="empty-state">Enter an email above to find a user.</div>
        </div>
      </div>

    </div>
  </main>

  <!-- ══════════════════════════════════════════════════════════
       TEMPLATE MODAL (Create / Edit)
  ══════════════════════════════════════════════════════════ -->
  <div class="modal-overlay" id="tplModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 id="tplModalTitle">New Template</h3>
        <button class="modal-close" id="closeTplModal">✕</button>
      </div>

      <div style="display:flex;flex-direction:column;gap:1rem">
        <input type="hidden" id="tplId" />

        <div class="form-group">
          <label>Template Name</label>
          <input type="text" id="tplName" placeholder="e.g. Job Application" />
        </div>

        <div class="form-group">
          <label>Description</label>
          <input type="text" id="tplDesc" placeholder="Short description shown to users" />
        </div>

        <div class="form-group">
          <label>Unlock Cost (coins)</label>
          <input type="number" id="tplCost" min="1" value="1" />
        </div>

        <div class="form-group">
          <label>Template File</label>
          <select id="tplFilePath">
            <option value="">— Loading files… —</option>
          </select>
          <small style="color:var(--text-dim);font-size:0.73rem;margin-top:0.35rem;display:block;line-height:1.5">
            Files are loaded from <code>templates/registry.json</code>.
            Add your HTML file to that list to make it appear here.
          </small>
        </div>

        <div class="form-group">
          <label>Status</label>
          <select id="tplActive">
            <option value="true">Active — visible to users</option>
            <option value="false">Inactive — hidden from users</option>
          </select>
        </div>

        <div id="tplErr" class="alert alert-error" hidden></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm"  id="cancelTplBtn">Cancel</button>
        <button class="btn btn-danger btn-sm" id="deleteTplBtn" hidden>Delete</button>
        <button class="btn btn-primary btn-sm" id="saveTplBtn">Save Template</button>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════════════════
       COINS MODAL
  ══════════════════════════════════════════════════════════ -->
  <div class="modal-overlay" id="coinsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Manage Coins</h3>
        <button class="modal-close" id="closeCoinsModal">✕</button>
      </div>

      <p class="text-sm text-dim mb-1">User</p>
      <p class="text-mono mb-1" id="coinsUserEmail" style="font-size:0.9rem;word-break:break-all"></p>
      <p class="text-sm mb-2">
        Current balance:
        <strong id="coinsBalance" style="color:#f0c040;font-family:var(--mono)"></strong>
      </p>

      <div class="form-group mb-2">
        <label>Amount</label>
        <input type="number" id="coinsAmount" min="1" value="10" />
      </div>

      <div id="coinsErr" class="alert alert-error" hidden></div>

      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm"  id="cancelCoinsBtn">Cancel</button>
        <button class="btn btn-danger btn-sm" id="deductCoinsBtn">— Deduct</button>
        <button class="btn btn-primary btn-sm" id="addCoinsBtn">+ Add</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { requireAdmin, logOut } from "./js/auth.js";
    import {
      collection, query, orderBy, getDocs,
      onSnapshot, addDoc, updateDoc, deleteDoc,
      doc, serverTimestamp, increment, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ══════════════════════════════════════════════════════════
    // INIT — Auth guard
    // ══════════════════════════════════════════════════════════
    const session = await requireAdmin();
    if (!session) throw new Error("Unauthorized");
    const { user } = session;
    document.getElementById("adminEmail").textContent = user.email;

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await logOut();
      window.location.href = "index.html";
    });

    // ══════════════════════════════════════════════════════════
    // TABS
    // ══════════════════════════════════════════════════════════
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
      });
    });

    // ══════════════════════════════════════════════════════════
    // REGISTRY — load available template files for dropdown
    // ══════════════════════════════════════════════════════════
    let registryFiles = [];

    try {
      const res = await fetch("/templates/registry.json");
      registryFiles = await res.json();
    } catch (e) {
      console.warn("[Admin] Could not load templates/registry.json:", e);
    }

    function populateFileDropdown(selectedPath = "") {
      const sel = document.getElementById("tplFilePath");
      sel.innerHTML = '<option value="">— Select a template file —</option>';

      if (registryFiles.length === 0) {
        sel.innerHTML = '<option value="">No files in registry.json yet</option>';
        return;
      }

      registryFiles.forEach(tpl => {
        const opt = document.createElement("option");
        opt.value = tpl.file;
        opt.textContent = `${tpl.name}  (${tpl.file})`;
        if (tpl.file === selectedPath) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    // ══════════════════════════════════════════════════════════
    // TEMPLATES — real-time list
    // ══════════════════════════════════════════════════════════
    const tplQuery = query(
      collection(db, "templates"),
      orderBy("createdAt", "desc")
    );

    onSnapshot(tplQuery, (snap) => {
      const list = document.getElementById("tplList");

      if (snap.empty) {
        list.innerHTML = '<div class="empty-state">No templates yet. Create one above.</div>';
        return;
      }

      list.innerHTML = "";

      snap.forEach(docSnap => {
        const t   = docSnap.data();
        const tid = docSnap.id;

        const row = document.createElement("div");
        row.className = "tpl-row";
        row.innerHTML = `
          <div class="tpl-info">
            <div class="title truncate">${esc(t.name)}</div>
            <small>
              ◈ ${t.unlockCost} coins to unlock
              &nbsp;·&nbsp;
              ${t.active ? '<span style="color:#5dade2">Active</span>' : '<span style="color:var(--text-dim)">Inactive</span>'}
              &nbsp;·&nbsp;
              <span style="opacity:0.55">${esc(t.filePath || "")}</span>
            </small>
          </div>
          <div class="tpl-actions">
            <button class="btn btn-ghost btn-sm" data-edit="${tid}">Edit</button>
            <button class="btn btn-sm ${t.active ? "btn-danger" : "btn-ghost"}"
              data-toggle="${tid}" data-current="${t.active}">
              ${t.active ? "Deactivate" : "Activate"}
            </button>
          </div>
        `;
        list.appendChild(row);
      });

      // Edit
      list.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => openEditTpl(btn.dataset.edit));
      });

      // Toggle active
      list.querySelectorAll("[data-toggle]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const nowActive = btn.dataset.current === "true";
          await updateDoc(doc(db, "templates", btn.dataset.toggle), {
            active: !nowActive
          });
        });
      });
    });

    // ── Open Edit Modal ───────────────────────────────────────
    async function openEditTpl(id) {
      const snap = await getDoc(doc(db, "templates", id));
      if (!snap.exists()) return;
      const t = snap.data();

      document.getElementById("tplId").value          = id;
      document.getElementById("tplModalTitle").textContent = "Edit Template";
      document.getElementById("tplName").value         = t.name;
      document.getElementById("tplDesc").value         = t.description || "";
      document.getElementById("tplCost").value         = t.unlockCost;
      document.getElementById("tplActive").value       = String(t.active);
      document.getElementById("deleteTplBtn").hidden   = false;
      document.getElementById("tplErr").hidden         = true;
      populateFileDropdown(t.filePath || "");
      document.getElementById("tplModal").classList.add("open");
    }

    // ── Open New Template Modal ───────────────────────────────
    document.getElementById("newTplBtn").addEventListener("click", () => {
      document.getElementById("tplId").value           = "";
      document.getElementById("tplModalTitle").textContent = "New Template";
      document.getElementById("tplName").value         = "";
      document.getElementById("tplDesc").value         = "";
      document.getElementById("tplCost").value         = 1;
      document.getElementById("tplActive").value       = "true";
      document.getElementById("deleteTplBtn").hidden   = true;
      document.getElementById("tplErr").hidden         = true;
      populateFileDropdown();
      document.getElementById("tplModal").classList.add("open");
    });

    // ── Close Template Modal ──────────────────────────────────
    function closeTplModal() {
      document.getElementById("tplModal").classList.remove("open");
    }
    document.getElementById("closeTplModal").addEventListener("click",  closeTplModal);
    document.getElementById("cancelTplBtn").addEventListener("click",   closeTplModal);

    // ── Save Template ─────────────────────────────────────────
    document.getElementById("saveTplBtn").addEventListener("click", async () => {
      const id       = document.getElementById("tplId").value;
      const name     = document.getElementById("tplName").value.trim();
      const desc     = document.getElementById("tplDesc").value.trim();
      const cost     = parseInt(document.getElementById("tplCost").value) || 1;
      const filePath = document.getElementById("tplFilePath").value;
      const active   = document.getElementById("tplActive").value === "true";
      const errEl    = document.getElementById("tplErr");

      // Validate
      if (!name) {
        errEl.textContent = "Template name is required.";
        errEl.hidden = false; return;
      }
      if (!filePath) {
        errEl.textContent = "Please select a template file.";
        errEl.hidden = false; return;
      }
      errEl.hidden = true;

      const payload = { name, description: desc, filePath, unlockCost: cost, active };

      if (id) {
        await updateDoc(doc(db, "templates", id), payload);
      } else {
        await addDoc(collection(db, "templates"), {
          ...payload,
          createdAt: serverTimestamp()
        });
      }

      closeTplModal();
    });

    // ── Delete Template ───────────────────────────────────────
    document.getElementById("deleteTplBtn").addEventListener("click", async () => {
      const id = document.getElementById("tplId").value;
      if (!id) return;
      if (!confirm("Delete this template permanently? This cannot be undone.")) return;
      await deleteDoc(doc(db, "templates", id));
      closeTplModal();
    });

    // ══════════════════════════════════════════════════════════
    // USERS — search + manage
    // ══════════════════════════════════════════════════════════
    document.getElementById("searchBtn").addEventListener("click", searchUsers);
    document.getElementById("userSearch").addEventListener("keydown", e => {
      if (e.key === "Enter") searchUsers();
    });

    async function searchUsers() {
      const term = document.getElementById("userSearch").value.trim().toLowerCase();
      const list = document.getElementById("userList");

      if (!term) {
        list.innerHTML = '<div class="empty-state">Enter an email to search.</div>';
        return;
      }

      list.innerHTML = '<div class="loader"><div class="spinner"></div> Searching…</div>';

      // Load all users and filter client-side
      // (Firestore free tier has no full-text search)
      const snap = await getDocs(
        query(collection(db, "users"), orderBy("email"))
      );

      const matches = snap.docs.filter(d =>
        (d.data().email || "").toLowerCase().includes(term)
      );

      if (matches.length === 0) {
        list.innerHTML = '<div class="empty-state">No users found.</div>';
        return;
      }

      list.innerHTML = "";

      matches.forEach(docSnap => {
        const u   = docSnap.data();
        const uid = docSnap.id;

        const row = document.createElement("div");
        row.className = "user-row";
        row.innerHTML = `
          <div class="user-info">
            <div class="email truncate">${esc(u.email)}</div>
            <small>
              Role: ${u.role}
              &nbsp;·&nbsp;
              <span class="user-coins">◈ ${u.coins}</span>
              &nbsp;·&nbsp;
              ${u.banned
                ? '<span class="tag tag-locked">Banned</span>'
                : '<span class="tag tag-active">Active</span>'
              }
            </small>
          </div>
          <div class="user-actions">
            <button class="btn btn-ghost btn-sm"
              data-coins-uid="${uid}"
              data-coins-email="${escAttr(u.email)}"
              data-coins-bal="${u.coins}">
              Coins
            </button>
            <button class="btn btn-sm ${u.banned ? "btn-primary" : "btn-danger"}"
              data-ban-uid="${uid}"
              data-ban-current="${u.banned}">
              ${u.banned ? "Unban" : "Ban"}
            </button>
          </div>
        `;
        list.appendChild(row);
      });

      // Coins buttons
      list.querySelectorAll("[data-coins-uid]").forEach(btn => {
        btn.addEventListener("click", () =>
          openCoinsModal(
            btn.dataset.coinsUid,
            btn.dataset.coinsEmail,
            parseInt(btn.dataset.coinsBal)
          )
        );
      });

      // Ban/Unban buttons
      list.querySelectorAll("[data-ban-uid]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const isBanned = btn.dataset.banCurrent === "true";
          const action   = isBanned ? "unban" : "ban";
          if (!confirm(`Are you sure you want to ${action} this user?`)) return;
          await updateDoc(doc(db, "users", btn.dataset.banUid), {
            banned: !isBanned
          });
          searchUsers(); // Refresh list
        });
      });
    }

    // ══════════════════════════════════════════════════════════
    // COINS MODAL
    // ══════════════════════════════════════════════════════════
    let coinsTargetUid = null;

    function openCoinsModal(uid, email, balance) {
      coinsTargetUid = uid;
      document.getElementById("coinsUserEmail").textContent = email;
      document.getElementById("coinsBalance").textContent   = `◈ ${balance}`;
      document.getElementById("coinsAmount").value          = 10;
      document.getElementById("coinsErr").hidden            = true;
      document.getElementById("coinsModal").classList.add("open");
    }

    function closeCoinsModal() {
      document.getElementById("coinsModal").classList.remove("open");
    }

    document.getElementById("closeCoinsModal").addEventListener("click",  closeCoinsModal);
    document.getElementById("cancelCoinsBtn").addEventListener("click",   closeCoinsModal);

    async function adjustCoins(direction) {
      const amount = parseInt(document.getElementById("coinsAmount").value);
      const errEl  = document.getElementById("coinsErr");

      if (!amount || amount < 1) {
        errEl.textContent = "Enter a valid amount (minimum 1).";
        errEl.hidden = false;
        return;
      }

      errEl.hidden = true;

      await updateDoc(doc(db, "users", coinsTargetUid), {
        coins: increment(direction * amount)
      });

      closeCoinsModal();
      searchUsers(); // Refresh to show new balance
    }

    document.getElementById("addCoinsBtn").addEventListener("click",    () => adjustCoins(1));
    document.getElementById("deductCoinsBtn").addEventListener("click", () => adjustCoins(-1));

    // ══════════════════════════════════════════════════════════
    // UTILS
    // ══════════════════════════════════════════════════════════
    function esc(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
    function escAttr(str) {
      return String(str).replace(/"/g, "&quot;");
    }

  </script>
</body>
</html>
