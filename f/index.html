<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form</title>
</head>
<body>

  <div id="errorState" style="display:none;font-family:sans-serif;font-size:0.95rem;color:#e74c3c;background:#2d0a0a;border:1px solid #7a1f1f;border-radius:6px;padding:1rem 1.25rem;margin:2rem auto;max-width:520px;"></div>

  <div id="formContainer"></div>

  <div id="successCard" style="display:none;text-align:center;padding:4rem 1rem;font-family:sans-serif;">
    <div style="font-size:3.5rem;margin-bottom:1rem">âœ”</div>
    <h2 style="margin-bottom:0.5rem">Response Submitted</h2>
    <p style="color:#888">Thank you. Your response has been recorded.</p>
  </div>

  <script type="module">
    import { db } from "../js/firebase.js";
    import {
      doc, getDoc, addDoc, collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const errorState    = document.getElementById("errorState");
    const formContainer = document.getElementById("formContainer");
    const successCard   = document.getElementById("successCard");

    function showError(msg) {
      errorState.textContent   = msg;
      errorState.style.display = "block";
    }

    const parts  = location.pathname.split("/").filter(Boolean);
    const formId = parts[parts.length - 1];

    let formData, templateData;

    try {
      const formSnap = await getDoc(doc(db, "forms", formId));
      if (!formSnap.exists())   { showError("Form not found."); return; }
      formData = formSnap.data();
      if (!formData.active)     { showError("This form is no longer active."); return; }

      const tplSnap = await getDoc(doc(db, "templates", formData.templateId));
      if (!tplSnap.exists())    { showError("Template not found."); return; }
      templateData = tplSnap.data();
      if (!templateData.active) { showError("This form has been deactivated."); return; }
    } catch (e) {
      showError("Failed to load form. Please try again.");
      return;
    }

    let templateHTML;
    try {
      const res = await fetch(templateData.filePath);
      if (!res.ok) throw new Error("HTTP " + res.status);
      templateHTML = await res.text();
    } catch (e) {
      showError("Could not load form template. Please try again.");
      return;
    }

    const parser = new DOMParser();
    const tplDoc = parser.parseFromString(templateHTML, "text/html");

    document.title = templateData.name || "Form";

    tplDoc.querySelectorAll("style").forEach(style => {
      const clone = document.createElement("style");
      clone.textContent = style.textContent;
      document.head.appendChild(clone);
    });

    tplDoc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
      const clone = document.createElement("link");
      clone.rel  = "stylesheet";
      clone.href = link.href;
      document.head.appendChild(clone);
    });

    formContainer.innerHTML = tplDoc.body.innerHTML;

    formContainer.querySelectorAll("script").forEach(old => {
      if (old.src && old.src.includes("blaze-sdk")) return;
      const s = document.createElement("script");
      if (old.src) { s.src = old.src; } else { s.textContent = old.textContent; }
      document.body.appendChild(s);
    });

    let submitted = false;

    window.BlazeSubmit = function () {
      if (submitted) return;
      const form = document.getElementById("blaze-form");
      if (!form) { alert("Form error. Please contact support."); return; }
      if (!form.checkValidity()) { form.reportValidity(); return; }
      submitted = true;
      form.querySelectorAll("input, textarea, select, button").forEach(el => el.disabled = true);
      const answers = {};
      for (const [key, val] of new FormData(form).entries()) { answers[key] = val; }
      saveSubmission(answers);
    };

    async function saveSubmission(answers) {
      try {
        await addDoc(collection(db, "submissions"), {
          formId,
          ownerId:    formData.ownerId,
          answers,
          locked:     true,
          unlocked:   false,
          unlockCost: templateData.unlockCost ?? 1,
          teaser: {
            submittedAt: serverTimestamp(),
            userAgent:   navigator.userAgent
          }
        });
        formContainer.style.display = "none";
        successCard.style.display   = "block";
      } catch (err) {
        submitted = false;
        const form = document.getElementById("blaze-form");
        if (form) form.querySelectorAll("input, textarea, select, button").forEach(el => el.disabled = false);
        showError("Submission failed. Please try again.");
      }
    }

  </script>
</body>
</html>